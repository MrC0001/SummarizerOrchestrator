//- views/summaries.pug
extends layout

block content
  h1 Stored Summaries

  .container
    if error
      p.error-message= error

    // Transcript selection form
    form(action="/summaries/view" method="post" id="viewSummariesForm")
      .form-group
        label(for="transcriptSelect") Select a Transcript:
        select(name="transcriptId" id="transcriptSelect" required aria-label="Select Transcript")
          option(value="" disabled selected) -- Select Transcript --
          each transcript in transcripts
            option(value=transcript.id)= `ID ${transcript.id} - ${transcript.scenario}`

      button(type="submit" class="btn-submit") View Summaries

    // Display the selected transcript text
    if transcript
      h2 Transcript Text
      .summary-box(style="margin-bottom: 20px; background-color: #1a1a1a; padding: 15px; border-radius: 10px;")
        pre.summary-content= transcript

    // Display summaries and metrics
    if summaries && summaries.length > 0
      h2 Summaries for Selected Transcript
      .summaries-container(style="display: flex; flex-direction: column; gap: 20px;")
        each summary in summaries
          .summary-panel(style="background-color: #242424; padding: 20px; border-radius: 10px; width: 100%;")
            .summary-box(style="margin-bottom: 10px;")
              h3(style="margin-bottom: 10px;") Provider: #{summary.providerName}
              if summary.summary
                p Summary:
                pre.summary-content(style="white-space: pre-wrap; margin-top: 10px;")= summary.summary
              else
                p.error-message No summary text available for this provider.

            // Metrics Box (separate below the summary box)
            if summary.metrics
              .metrics-box(style="margin-top: 10px; background-color: #1a1a1a; padding: 10px; border-radius: 10px; border: 1px solid #66cc66;")
                h4 Metrics:
                ul
                  li ROUGE-1: #{summary.metrics.rouge1 || 'N/A'}
                  li ROUGE-2: #{summary.metrics.rouge2 || 'N/A'}
                  li ROUGE-L: #{summary.metrics.rougeL || 'N/A'}
                  li BERT Precision: #{summary.metrics.bertPrecision || 'N/A'}
                  li BERT Recall: #{summary.metrics.bertRecall || 'N/A'}
                  li BERT F1: #{summary.metrics.bertF1 || 'N/A'}
                  li BLEU: #{summary.metrics.bleu || 'N/A'}
                  li METEOR: #{summary.metrics.meteor || 'N/A'}
                  li Length Ratio: #{summary.metrics.lengthRatio || 'N/A'}
                  li Redundancy: #{summary.metrics.redundancy || 'N/A'}
                  li Created At: #{summary.metrics.createdAt || 'N/A'}
            else
              p.info-message No metrics available for this summary.

    else if transcript
      p.info-message No summaries found for the selected transcript. Please summarize it first.

  .link-group
    a(href="/" class="btn-link") Back to Summarize

  // Client-side validation script
  script.
    document.addEventListener('DOMContentLoaded', function () {
      try {
        const form = document.getElementById('viewSummariesForm');
        const transcriptSelect = document.getElementById('transcriptSelect');

        form.addEventListener('submit', (e) => {
          if (!transcriptSelect.value || transcriptSelect.value === "") {
            e.preventDefault();
            console.error('No transcript selected for viewing summaries.');
            alert('Please select a transcript to view summaries.');
          }
        });
      } catch (error) {
        console.error('Error initializing view summaries form:', error);
      }
    });
